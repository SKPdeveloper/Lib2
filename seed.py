import sqlite3
import datetime
import random
import hashlib

# З'єднання з БД
conn = sqlite3.connect('library.db')
c = conn.cursor()

# Очищення таблиць, якщо вони існують
tables = [
    'users', 'books', 'book_requests', 'ratings', 
    'chat_messages', 'user_book_history'
]

for table in tables:
    c.execute(f"DROP TABLE IF EXISTS {table}")

# Створення таблиць
c.execute('''CREATE TABLE users
            (id INTEGER PRIMARY KEY, username TEXT, password TEXT, role TEXT)''')

c.execute('''CREATE TABLE books
            (id INTEGER PRIMARY KEY, title TEXT, author TEXT, genre TEXT, 
             year INTEGER, description TEXT, available BOOLEAN)''')

c.execute('''CREATE TABLE book_requests
            (id INTEGER PRIMARY KEY, user_id INTEGER, book_id INTEGER, 
             status TEXT, request_date TEXT)''')

c.execute('''CREATE TABLE ratings
            (id INTEGER PRIMARY KEY, user_id INTEGER, book_id INTEGER, 
             rating INTEGER, comment TEXT)''')

c.execute('''CREATE TABLE chat_messages
            (id INTEGER PRIMARY KEY, from_user_id INTEGER, to_user_id INTEGER, 
             message TEXT, timestamp TEXT)''')

c.execute('''CREATE TABLE user_book_history
            (id INTEGER PRIMARY KEY, user_id INTEGER, book_id INTEGER, timestamp TEXT)''')

# Функція для генерації дати в минулому
def random_date(days_ago_start=1, days_ago_end=60):
    days_ago = random.randint(days_ago_start, days_ago_end)
    date = datetime.datetime.now() - datetime.timedelta(days=days_ago)
    return date.strftime("%Y-%m-%d %H:%M:%S")

# Функція для простого хешування паролів
def hash_password(password):
    return hashlib.sha256(password.encode()).hexdigest()

# Додавання бібліотекарів
librarians = [
    (1, "admin", "admin123", "librarian"),
    (2, "librarian", "library123", "librarian")
]

c.executemany("INSERT INTO users VALUES (?, ?, ?, ?)", librarians)

# Додавання читачів
readers = [
    (3, "reader1", "pass1", "reader"),
    (4, "reader2", "pass2", "reader"),
    (5, "reader3", "pass3", "reader"),
    (6, "reader4", "pass4", "reader"),
    (7, "reader5", "pass5", "reader"),
    (8, "reader6", "pass6", "reader"),
    (9, "reader7", "pass7", "reader"),
    (10, "reader8", "pass8", "reader"),
    (11, "reader9", "pass9", "reader"),
    (12, "reader10", "pass10", "reader")
]

c.executemany("INSERT INTO users VALUES (?, ?, ?, ?)", readers)

# Додавання книг (деякі з них недоступні - на руках у читачів)
books = [
    # Українська класика
    (1, "Тіні забутих предків", "Михайло Коцюбинський", "Художня література", 1911, "Повість про кохання гуцульських Ромео і Джульєтти.", True),
    (2, "Лісова пісня", "Леся Українка", "Драма", 1911, "Драма-феєрія про кохання лісової мавки до сільського парубка.", False),
    (3, "Тигролови", "Іван Багряний", "Пригодницький роман", 1944, "Пригодницький роман про втечу українця з ГУЛАГу.", True),
    (4, "Зачарована Десна", "Олександр Довженко", "Автобіографічна повість", 1956, "Автобіографічна кіноповість про дитинство автора.", False),
    (5, "Маруся Чурай", "Ліна Костенко", "Історичний роман", 1979, "Історичний роман у віршах про легендарну українську поетесу.", True),
    
    # Сучасна українська література
    (6, "Солодка Даруся", "Марія Матіос", "Драма", 2004, "Драма на три життя про долю дівчини в буковинському селі.", True),
    (7, "Ворошиловград", "Сергій Жадан", "Роман", 2010, "Роман про повернення героя на малу батьківщину.", False),
    (8, "Століття Якова", "Володимир Лис", "Роман", 2010, "Сага про життя волинського селянина Якова Меха.", True),
    (9, "Музей покинутих секретів", "Оксана Забужко", "Роман", 2009, "Роман про долі трьох поколінь українців.", False),
    (10, "Фелікс Австрія", "Софія Андрухович", "Роман", 2014, "Роман про складні стосунки служниці і господині в Станіславові.", True),
    
    # Сучасна українська проза
    (11, "Інтернат", "Сергій Жадан", "Роман", 2017, "Роман про війну на сході України.", True),
    (12, "Амадока", "Софія Андрухович", "Роман", 2020, "Сімейна сага про травму, пам'ять і любов.", False),
    (13, "Мідні буки", "Юрій Андрухович", "Роман", 2021, "Містичний детектив про старовинне галицьке місто.", True),
    (14, "Радіо Ніч", "Юрій Андрухович", "Роман", 2021, "Політичний трилер про диктатуру і свободу.", False),
    (15, "Юпак", "Сашко Дерманський", "Дитяча література", 2020, "Книга про пригоди хлопчика-вовчика.", True),
    
    # Українська поезія
    (16, "Крила", "Ліна Костенко", "Поезія", 2015, "Збірка віршів видатної української поетеси.", True),
    (17, "Антологія української поезії ХХ століття", "Різні автори", "Поезія", 2016, "Збірка найкращих віршів українських поетів ХХ століття.", False),
    (18, "Тисяча і одна ніч", "Дмитро Павличко", "Поезія", 2010, "Збірка інтимної лірики відомого поета.", True),
    (19, "Земля така гаряча", "Василь Стус", "Поезія", 1991, "Збірка віршів видатного українського поета-дисидента.", False),
    (20, "Чорна ніч, білі стіни", "Юрій Іздрик", "Поезія", 2018, "Збірка поезій з елементами прози від відомого автора.", True),
    
    # Українські детективи
    (21, "Дівчинка, яка шукала маму", "Андрій Кокотюха", "Детектив", 2018, "Детективна історія про пошуки зниклої людини.", True),
    (22, "Ключ", "Василь Шкляр", "Детектив", 1999, "Детектив про журналіста, який розплутує кримінальну справу.", False),
    (23, "Темна вода", "Андрій Кокотюха", "Детектив", 2020, "Ретро-детектив про інспектора карного розшуку.", True),
    (24, "Справа отамана Зеленого", "Андрій Кокотюха", "Історичний детектив", 2014, "Детектив про часи УНР і Громадянської війни.", False),
    (25, "Червоний", "Андрій Кокотюха", "Історичний роман", 2012, "Історичний роман про повстанський рух.", True),
    
    # Українська фантастика
    (26, "Лазарус", "Сергій Пономаренко", "Фантастика", 2018, "Роман-антиутопія про ближче майбутнє.", True),
    (27, "Час смертохристів", "Юрій Щербак", "Фантастика", 2011, "Футуристичний роман-антиутопія.", False),
    (28, "Телефонуй мені, говори зі мною", "Володимир Лис", "Містика", 2018, "Містичний роман про невидимий зв'язок між людьми.", True),
    (29, "Дім у якому жевріє світло", "Дорж Бату", "Фантастика", 2020, "Науково-фантастичний роман про вибір і призначення.", False),
    (30, "КайдашІвські дні", "Володимир Даниленко", "Містика", 2016, "Містична історія про сучасну українську родину.", True),
    
    # Історичні романи
    (31, "Чорний ворон", "Василь Шкляр", "Історичний роман", 2009, "Роман про повстанський рух українських селян.", True),
    (32, "Вогняний стовп", "Роман Іваничук", "Історичний роман", 1993, "Роман про українських січових стрільців.", False),
    (33, "Залишенець", "Василь Шкляр", "Історичний роман", 2010, "Історичний роман про отамана Чорного Ворона.", True),
    (34, "Червоний", "Василь Шкляр", "Історичний роман", 2012, "Роман про УПА в боротьбі з радянськими окупантами.", False),
    (35, "Троща", "Василь Шкляр", "Історичний роман", 2017, "Роман про долю учасника визвольних змагань.", True),
    
    # Переклади світової класики
    (36, "Гордість і упередження", "Джейн Остін", "Роман", 1813, "Романтичний роман про сім'ю Беннет.", True),
    (37, "1984", "Джордж Орвелл", "Антиутопія", 1949, "Роман про тоталітаризм та суспільство під наглядом.", False),
    (38, "Сто років самотності", "Габріель Гарсія Маркес", "Магічний реалізм", 1967, "Сімейна сага роду Буендіа.", True),
    (39, "Майстер і Маргарита", "Михайло Булгаков", "Фантастика", 1967, "Роман про візит диявола до Москви.", False),
    (40, "Убити пересмішника", "Гарпер Лі", "Художня література", 1960, "Історія про расову несправедливість в американському півдні.", True),
    
    # Сучасні переклади
    (41, "Маленьке життя", "Ганья Янаґігара", "Роман", 2015, "Епічний роман про дружбу, любов і травму.", True),
    (42, "Хмарний атлас", "Девід Мітчелл", "Фантастика", 2004, "Роман, що складається з шести пов'язаних історій.", False),
    (43, "Дівчина у потягу", "Пола Гокінс", "Трилер", 2015, "Психологічний трилер про розлучену жінку-алкоголічку.", True),
    (44, "Норвезький ліс", "Харукі Муракамі", "Роман", 1987, "Роман про любов, втрату і самотність.", False),
    (45, "Голодні ігри", "Сюзанна Коллінз", "Антиутопія", 2008, "Роман про антиутопічне майбутнє, де діти б'ються насмерть.", True),
    
    # Науково-популярна література
    (46, "Коротка історія майже всього", "Білл Брайсон", "Наука", 2003, "Книга про науку та історію Всесвіту.", True),
    (47, "Видимі й невидимі світи", "Карло Ровеллі", "Наука", 2020, "Книга про квантову фізику.", False),
    (48, "Людина розумна", "Ювал Ной Харарі", "Історія", 2011, "Книга про історію людства.", True),
    (49, "Нові мандри Гулівера", "Михайло Слабошпицький", "Подорожі", 2017, "Живі репортажі з різних куточків світу.", False),
    (50, "21 урок для 21 століття", "Ювал Ной Харарі", "Філософія", 2018, "Книга про важливі проблеми сучасності.", True)
]

c.executemany("INSERT INTO books VALUES (?, ?, ?, ?, ?, ?, ?)", books)

# Додавання запитів на книги
book_requests = []
statuses = ["pending", "approved", "rejected"]
request_id = 1

for reader_id in range(3, 13):  # ID читачів від 3 до 12
    # Кожен читач робить 3-5 запитів
    num_requests = random.randint(3, 5)
    for _ in range(num_requests):
        book_id = random.randint(1, 50)
        status = random.choice(statuses)
        request_date = random_date()
        book_requests.append((request_id, reader_id, book_id, status, request_date))
        
        # Якщо запит схвалено, додаємо книгу до історії користувача
        if status == "approved":
            c.execute(
                "INSERT INTO user_book_history (user_id, book_id, timestamp) VALUES (?, ?, ?)",
                (reader_id, book_id, request_date)
            )
        
        request_id += 1

c.executemany("INSERT INTO book_requests VALUES (?, ?, ?, ?, ?)", book_requests)

# Додавання оцінок та коментарів
ratings = []
rating_id = 1
comments = [
    "Чудова книга! Дуже рекомендую.", 
    "Цікавий сюжет, але кінцівка розчарувала.", 
    "Одна з моїх улюблених книг усіх часів!",
    "Було важко читати, але це того варте.",
    "Надзвичайно захоплююча історія, не міг відірватися.",
    "Середнячок, нічого особливого.",
    "Книга повністю змінила мій погляд на життя.",
    "Не сподобалась, витрачений час.",
    "Чудовий стиль написання, але сюжет передбачуваний.",
    "Раджу прочитати всім поціновувачам жанру."
]

for reader_id in range(3, 13):  # ID читачів від 3 до 12
    # Кожен читач оцінює 5-8 книг
    num_ratings = random.randint(5, 8)
    rated_books = random.sample(range(1, 51), num_ratings)
    
    for book_id in rated_books:
        rating_value = random.randint(1, 5)
        comment = random.choice(comments)
        ratings.append((rating_id, reader_id, book_id, rating_value, comment))
        rating_id += 1

c.executemany("INSERT INTO ratings VALUES (?, ?, ?, ?, ?)", ratings)

# Додавання повідомлень в чаті
chat_messages = []
message_id = 1
reader_messages = [
    "Добрий день, коли буде доступна книга, яку я замовив?",
    "Дякую за рекомендацію! Книга справді чудова.",
    "Чи можу я продовжити термін користування книгою?",
    "Я не можу знайти книгу, яку шукаю. Чи могли б ви допомогти?",
    "Коли надійдуть нові книги у бібліотеку?",
    "Хотів би замовити книгу, але її немає в каталозі. Що робити?",
    "Вчора повернув книгу, але система показує, що вона все ще у мене. Допоможіть, будь ласка.",
    "Чи є у вас рекомендації книг у жанрі фантастики?",
    "Дякую за швидку відповідь!"
]

librarian_messages = [
    "Книга буде доступна через 3 дні. Дякую за терпіння!",
    "Радий, що вам сподобалась рекомендація! Маю ще кілька пропозицій для вас.",
    "Так, термін користування продовжено на 2 тижні.",
    "Звичайно, дайте більше інформації про книгу, і я допоможу вам її знайти.",
    "Нові надходження очікуються наступного тижня. Я повідомлю вас, коли вони будуть доступні.",
    "Ми можемо замовити цю книгу для вас. Будь ласка, надайте назву та автора.",
    "Перевірив систему і виправив помилку. Тепер усе в порядку!",
    "У нас є чудові книги Сергія Жадана та Василя Шкляра. Хочете щось конкретне?",
    "Завжди раді допомогти! Звертайтесь, якщо виникнуть ще питання."
]

# Для кожного читача створюємо діалог з бібліотекарем
for reader_id in range(3, 13):  # ID читачів від 3 до 12
    librarian_id = random.choice([1, 2])  # Випадково вибираємо бібліотекаря
    
    # Створюємо від 3 до 7 повідомлень в діалозі
    num_messages = random.randint(3, 7)
    
    # Початковий час для діалогу (від 1 до 30 днів тому)
    base_date = datetime.datetime.now() - datetime.timedelta(days=random.randint(1, 30))
    
    for i in range(num_messages):
        # Якщо i парне, повідомлення від читача, інакше - від бібліотекаря
        if i % 2 == 0:
            from_id = reader_id
            to_id = librarian_id
            message = random.choice(reader_messages)
        else:
            from_id = librarian_id
            to_id = reader_id
            message = random.choice(librarian_messages)
        
        # Додаємо від 5 до 60 хвилин між повідомленнями
        message_date = base_date + datetime.timedelta(minutes=random.randint(5, 60) * i)
        timestamp = message_date.strftime("%Y-%m-%d %H:%M:%S")
        
        chat_messages.append((message_id, from_id, to_id, message, timestamp))
        message_id += 1

c.executemany("INSERT INTO chat_messages VALUES (?, ?, ?, ?, ?)", chat_messages)

# Збереження змін і закриття з'єднання
conn.commit()
conn.close()

print("База даних успішно заповнена!")